<section class="ivr-builder">
  <header class="top-row">
    <div>
      <h1>IVR Builder</h1>
      <p>
        {{ enabledCount() }} active module(s), {{ connections().length }} connection(s)
      </p>
    </div>
    <a routerLink="/main-menu" class="back-link">Back to Main Menu</a>
  </header>

  <section class="palette">
    <h2>Add Module</h2>
    <div class="palette-controls">
      <label for="module-type">Module type</label>
      <select
        id="module-type"
        [ngModel]="selectedTemplate()"
        (ngModelChange)="selectedTemplate.set($event)"
      >
        <option *ngFor="let item of templates" [ngValue]="item.type">{{ item.label }}</option>
      </select>
      <button type="button" (click)="addModule()">Add module</button>
    </div>
  </section>

  <section class="canvas-panel">
    <h2>Flow Canvas</h2>
    <p class="hint">
      Drag modules to position them. Drag from an output dot to an input dot to create arrows.
    </p>

    <div
      class="canvas"
      #canvasRoot
      (pointerenter)="setCanvasRef(canvasRoot)"
      (pointermove)="onCanvasPointerMove($event)"
      (pointerup)="onCanvasPointerUp($event)"
      (pointercancel)="onCanvasPointerUp($event)"
      (pointerleave)="onCanvasPointerUp($event)"
    >
      <div class="canvas-grid"></div>
      <svg class="connections">
        <defs>
          <marker
            id="arrowhead"
            markerWidth="10"
            markerHeight="7"
            refX="8"
            refY="3.5"
            orient="auto"
          >
            <polygon points="0 0, 10 3.5, 0 7"></polygon>
          </marker>
        </defs>
        <path
          *ngFor="let connection of renderedConnections()"
          [attr.d]="connection.path"
          marker-end="url(#arrowhead)"
          class="connection-line"
          (dblclick)="removeConnection(connection.id)"
        ></path>
        <path
          *ngIf="connectionDraft()"
          [attr.d]="draftPath()"
          marker-end="url(#arrowhead)"
          class="connection-line draft"
        ></path>
      </svg>

      <article
        class="module-card"
        *ngFor="let module of modules(); let i = index"
        [style.left.px]="module.x"
        [style.top.px]="module.y"
        (pointerdown)="setCanvasRef(canvasRoot); startModuleDrag(module.id, $event)"
      >
        <div class="card-head">
          <strong>{{ i + 1 }}. {{ module.type }}</strong>
          <label>
            <input
              type="checkbox"
              [checked]="module.enabled"
              (change)="toggleEnabled(module.id)"
            />
            Enabled
          </label>
        </div>
        <div class="ports">
          <button
            type="button"
            class="port input"
            [attr.data-port-input]="module.id"
            title="Drop an arrow here"
          ></button>
          <button
            type="button"
            class="port output"
            (pointerdown)="setCanvasRef(canvasRoot); startConnectionDrag(module.id, $event)"
            title="Drag to connect"
          ></button>
        </div>

        <label class="field">
          <span>Name</span>
          <input
            type="text"
            [value]="module.name"
            (input)="updateName(module.id, $any($event.target).value)"
          />
        </label>

        <label class="field">
          <span>Prompt</span>
          <textarea
            rows="2"
            [value]="module.prompt"
            (input)="updatePrompt(module.id, $any($event.target).value)"
          ></textarea>
        </label>

        <div class="actions">
          <button type="button" (click)="moveUp(module.id)">Bring Forward</button>
          <button type="button" class="danger" (click)="removeModule(module.id)">Remove</button>
        </div>
      </article>
    </div>
  </section>
</section>
